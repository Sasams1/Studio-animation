-- إنشاء زر Ungroup في أعلى الشاشة
local ungroupButton = Instance.new("TextButton")
ungroupButton.Name = "UngroupButton"
ungroupButton.Text = "Ungroup"
ungroupButton.Size = UDim2.new(0, 100, 0, 30)
ungroupButton.Position = UDim2.new(0.5, -50, 0, 10) -- منتصف أعلى الشاشة
ungroupButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
ungroupButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ungroupButton.ZIndex = 100
ungroupButton.Parent = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui

-- نظام السحب والتحريك
local dragging = false
local dragStart, startPos

ungroupButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = ungroupButton.Position
        ungroupButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
    end
end)

ungroupButton.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        ungroupButton.Position = UDim2.new(
            startPos.X.Scale,
            math.clamp(startPos.X.Offset + delta.X, 0, 1000),
            startPos.Y.Scale,
            math.clamp(startPos.Y.Offset + delta.Y, 0, 100)
        )
    end
end)

ungroupButton.InputEnded:Connect(function()
    dragging = false
    ungroupButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
end)

-- الوظيفة المحسنة باستخدام نظام ExplorerPanel
local function PerformExplorerUngroup()
    -- 1. الحصول على التحديد من نظام ExplorerPanel
    local getSelection = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui.ExplorerPanel:FindFirstChild("GetSelection")
    if not getSelection then
        return false, "نظام التحديد غير موجود"
    end
    
    local selectedObjects = getSelection:Invoke()
    if not selectedObjects or #selectedObjects == 0 then
        return false, "لم يتم تحديد أي عناصر"
    end
    
    -- 2. تصفية الموديلات فقط
    local selectedModels = {}
    for _, obj in ipairs(selectedObjects) do
        if obj and obj:IsA("Model") then
            table.insert(selectedModels, obj)
        end
    end
    
    if #selectedModels == 0 then
        return false, "العناصر المحددة ليست موديلات"
    end
    
    -- 3. عملية التفكيك
    local successCount = 0
    for _, model in ipairs(selectedModels) do
        local success, err = pcall(function()
            local parent = model.Parent
            if not parent then return end
            
            -- نقل الأبناء
            local children = model:GetChildren()
            for _, child in ipairs(children) do
                child.Parent = parent
            end
            
            -- إزالة من التحديد باستخدام SetSelection إذا كان موجوداً
            local setSelection = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui.ExplorerPanel:FindFirstChild("SetSelection")
            if setSelection then
                local currentSelection = getSelection:Invoke() or {}
                local newSelection = {}
                for _, item in ipairs(currentSelection) do
                    if item ~= model then
                        table.insert(newSelection, item)
                    end
                end
                setSelection:Invoke(newSelection)
            end
            
            -- تدمير الموديل
            model:Destroy()
            successCount = successCount + 1
        end)
        
        if not success then
            warn("خطأ في تفكيك الموديل: "..tostring(err))
        end
    end
    
    -- 4. تحديث الواجهة إذا أمكن
    local explorer = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui.ExplorerPanel:FindFirstChild("Explorer")
    if explorer then
        -- يمكنك هنا استدعاء أي وظيفة تحديث موجودة في السكربت الأصلي
    end
    
    return successCount > 0, successCount > 0 and "تم تفكيك "..successCount.." موديل" or "فشل في التفكيك"
end

-- ربط الزر بالوظيفة
ungroupButton.MouseButton1Click:Connect(function()
    local success, result, message = pcall(PerformExplorerUngroup)
    
    if not success then
        message = "حدث خطأ في النظام: "..tostring(result)
        warn(message)
    elseif not result then
        message = message or "فشل في تفكيك الموديلات"
    end
    
    -- عرض الرسالة
    local warningText = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui:FindFirstChild("WarningText")
    if warningText then
        warningText.Text = message
        warningText.Visible = true
        
        -- تغيير لون الزر للإشارة للحالة
        ungroupButton.BackgroundColor3 = result and Color3.fromRGB(60, 200, 60) or Color3.fromRGB(200, 60, 60)
        
        wait(2)
        warningText.Visible = false
        ungroupButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    end
end)

-- إظهار رسالة عند التشغيل
local warningText = game:GetService("Players").LocalPlayer.PlayerGui.StudioGui:FindFirstChild("WarningText")
if warningText then
    warningText.Text = "أداة Ungroup جاهزة (نظام ExplorerPanel)"
    warningText.Visible = true
    wait(2)
    warningText.Visible = false
end
